<!DOCTYPE html>
<html>
<head>
    <title>Meal Planner</title>
    <script>
        async function getMenu() {
            const response = await fetch('https://dining.berkeley.edu/menus/');
            const text = await response.text();
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(text, 'text/html');

            const menuSections = htmlDoc.querySelectorAll('.meal-menu');
            let allMenuItems = [];

            menuSections.forEach(section => {
                const mealName = section.querySelector('h2').textContent.trim();
                const items = Array.from(section.querySelectorAll('.menu-item')).map(item => {
                    const itemName = item.querySelector('.item-name').textContent.trim();
                    const itemNutrition = item.querySelector('.nutrition-info');
                    let nutritionData = { calories: 0, carbs: 0, protein: 0, fat: 0 }; // Default values

                    if (itemNutrition) {
                        const nutritionText = itemNutrition.textContent.trim();
                        const lines = nutritionText.split('\n');

                        lines.forEach(line => {
                            const trimmedLine = line.trim();
                            if (trimmedLine.startsWith('Calories:')) {
                                const caloriesMatch = trimmedLine.match(/Calories: (\d+)/);
                                if (caloriesMatch) nutritionData.calories = parseInt(caloriesMatch[1]);
                            } else if (trimmedLine.startsWith('Carbs:')) {
                                const carbsMatch = trimmedLine.match(/Carbs: (\d+)g/);
                                if (carbsMatch) nutritionData.carbs = parseInt(carbsMatch[1]);
                            } else if (trimmedLine.startsWith('Protein:')) {
                                const proteinMatch = trimmedLine.match(/Protein: (\d+)g/);
                                if (proteinMatch) nutritionData.protein = parseInt(proteinMatch[1]);
                            } else if (trimmedLine.startsWith('Fat:')) {
                                const fatMatch = trimmedLine.match(/Fat: (\d+)g/);
                                if (fatMatch) nutritionData.fat = parseInt(fatMatch[1]);
                            }
                        });
                    }
                    return { name: itemName, nutrition: nutritionData, meal: mealName };
                });
                allMenuItems = allMenuItems.concat(items);
            });
            return allMenuItems;
        }

        function recommendMeals(menu, goal) {
            let filteredMeals = [];
            let totalCarbs = 0;
            let totalProtein = 0;
            let totalFat = 0;
            let totalCalories = 0;

            if (goal.toLowerCase().includes('carbs')) {
                filteredMeals = menu.filter(item => item.nutrition.carbs > 0);
                filteredMeals.sort((a, b) => b.nutrition.carbs - a.nutrition.carbs);
            } else if (goal.toLowerCase().includes('protein')) {
                filteredMeals = menu.filter(item => item.nutrition.protein > 0);
                filteredMeals.sort((a, b) => b.nutrition.protein - a.nutrition.protein);
            } else if (goal.toLowerCase().includes('fat')) {
                filteredMeals = menu.filter(item => item.nutrition.fat > 0);
                filteredMeals.sort((a, b) => b.nutrition.fat - a.nutrition.fat);
            } else if (goal.toLowerCase().includes('calories')) {
                filteredMeals = menu.filter(item => item.nutrition.calories > 0);
                filteredMeals.sort((a, b) => b.nutrition.calories - a.nutrition.calories);
            }

            const selectedMeals = [];
            const maxMeals = 5;

            for (let i = 0; i < Math.min(maxMeals, filteredMeals.length); i++) {
                const meal = filteredMeals[i];
                totalCarbs += meal.nutrition.carbs;
                totalProtein += meal.nutrition.protein;
                totalFat += meal.nutrition.fat;
                totalCalories += meal.nutrition.calories;
                selectedMeals.push(meal);
            }

            return { meals: selectedMeals, totals: { carbs: totalCarbs, protein: totalProtein, fat: totalFat, calories: totalCalories } };
        }

        async function generateMealPlan() {
            const goal = document.getElementById('goalInput').value;
            const menu = await getMenu();
            const mealPlan = recommendMeals(menu, goal);

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<h2>Recommended Meal Plan:</h2>';

            if (mealPlan.meals.length === 0) {
                resultDiv.innerHTML += '<p>No meals found matching your goal.</p>';
                return;
            }

            mealPlan.meals.forEach(meal => {
                resultDiv.innerHTML += `<p><strong>${meal.name}</strong> (${meal.meal}) - Carbs: ${meal.nutrition.carbs}g, Protein: ${meal.nutrition.protein}g, Fat: ${meal.nutrition.fat}g, Calories: ${meal.nutrition.calories}cal</p>`;
            });
            resultDiv.innerHTML += `<p><strong>Total:</strong> Carbs: ${mealPlan.totals.carbs}g, Protein: ${mealPlan.totals.protein}g, Fat: ${mealPlan.totals.fat}g, Calories: ${mealPlan.totals.calories}cal</p>`;
        }
    </script>
</head>
<body>
    <h1>Meal Planner</h1>
    <label for="goalInput">Enter your macro goal:</label>
    <input type="text" id="goalInput" placeholder="e.g., Eat more carbs">
    <button onclick="generateMealPlan()">Generate Meal Plan</button>
    <div id="result"></div>
</body>
</html>